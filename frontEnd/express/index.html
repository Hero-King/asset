<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Express源码学习 | HeroKing的个人笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link href="https://cdn.bootcdn.net/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet">
    <script src="https://hm.baidu.com/hm.js?3691b93bb6fcef0775ef18a936452b97" defer="true"></script>
    <meta name="description" content="学习犹如逆水行舟,不进则退">
    
    <link rel="preload" href="/assets/css/0.styles.51c3fc7f.css" as="style"><link rel="preload" href="/assets/js/app.f6a8c955.js" as="script"><link rel="preload" href="/assets/js/2.163e2f28.js" as="script"><link rel="preload" href="/assets/js/1.f9594dd0.js" as="script"><link rel="preload" href="/assets/js/47.9d307bbb.js" as="script"><link rel="prefetch" href="/assets/js/10.da97ed6b.js"><link rel="prefetch" href="/assets/js/100.a231b992.js"><link rel="prefetch" href="/assets/js/101.6d35d549.js"><link rel="prefetch" href="/assets/js/11.0e411808.js"><link rel="prefetch" href="/assets/js/12.947f28db.js"><link rel="prefetch" href="/assets/js/13.14b6263c.js"><link rel="prefetch" href="/assets/js/14.d0c47c93.js"><link rel="prefetch" href="/assets/js/15.148f04fa.js"><link rel="prefetch" href="/assets/js/16.e6f33590.js"><link rel="prefetch" href="/assets/js/17.ab2d7eb1.js"><link rel="prefetch" href="/assets/js/18.5d8b1599.js"><link rel="prefetch" href="/assets/js/19.24ad168e.js"><link rel="prefetch" href="/assets/js/20.853e8cab.js"><link rel="prefetch" href="/assets/js/21.8218c0fb.js"><link rel="prefetch" href="/assets/js/22.603a3453.js"><link rel="prefetch" href="/assets/js/23.f4004600.js"><link rel="prefetch" href="/assets/js/24.22310276.js"><link rel="prefetch" href="/assets/js/25.cb21eece.js"><link rel="prefetch" href="/assets/js/26.c54da579.js"><link rel="prefetch" href="/assets/js/27.f57556cf.js"><link rel="prefetch" href="/assets/js/28.2649c5b6.js"><link rel="prefetch" href="/assets/js/29.f939fbc6.js"><link rel="prefetch" href="/assets/js/3.678789c9.js"><link rel="prefetch" href="/assets/js/30.5fd85372.js"><link rel="prefetch" href="/assets/js/31.df19fc4c.js"><link rel="prefetch" href="/assets/js/32.8bcbb2d6.js"><link rel="prefetch" href="/assets/js/33.cbd36427.js"><link rel="prefetch" href="/assets/js/34.6230043f.js"><link rel="prefetch" href="/assets/js/35.7c81472b.js"><link rel="prefetch" href="/assets/js/36.25210112.js"><link rel="prefetch" href="/assets/js/37.fd55f30a.js"><link rel="prefetch" href="/assets/js/38.59816109.js"><link rel="prefetch" href="/assets/js/39.2e72acbe.js"><link rel="prefetch" href="/assets/js/4.30e44ed7.js"><link rel="prefetch" href="/assets/js/40.df456fee.js"><link rel="prefetch" href="/assets/js/41.1d2a5b34.js"><link rel="prefetch" href="/assets/js/42.875b2f31.js"><link rel="prefetch" href="/assets/js/43.dcf673ca.js"><link rel="prefetch" href="/assets/js/44.b08ecd05.js"><link rel="prefetch" href="/assets/js/45.0fef276e.js"><link rel="prefetch" href="/assets/js/46.08975b0f.js"><link rel="prefetch" href="/assets/js/48.4d62cb9d.js"><link rel="prefetch" href="/assets/js/49.6e97050f.js"><link rel="prefetch" href="/assets/js/5.6beae35f.js"><link rel="prefetch" href="/assets/js/50.9b9a3ad7.js"><link rel="prefetch" href="/assets/js/51.f973567d.js"><link rel="prefetch" href="/assets/js/52.6501423b.js"><link rel="prefetch" href="/assets/js/53.ba00f3d2.js"><link rel="prefetch" href="/assets/js/54.161545a4.js"><link rel="prefetch" href="/assets/js/55.3e7db058.js"><link rel="prefetch" href="/assets/js/56.c552d322.js"><link rel="prefetch" href="/assets/js/57.b71253b7.js"><link rel="prefetch" href="/assets/js/58.fcee000e.js"><link rel="prefetch" href="/assets/js/59.2afd7277.js"><link rel="prefetch" href="/assets/js/6.e78facd0.js"><link rel="prefetch" href="/assets/js/60.430c4bb8.js"><link rel="prefetch" href="/assets/js/61.244cd577.js"><link rel="prefetch" href="/assets/js/62.b8922694.js"><link rel="prefetch" href="/assets/js/63.5bf13672.js"><link rel="prefetch" href="/assets/js/64.dbef2543.js"><link rel="prefetch" href="/assets/js/65.90c5c7d1.js"><link rel="prefetch" href="/assets/js/66.aee6a0ba.js"><link rel="prefetch" href="/assets/js/67.5c20fecb.js"><link rel="prefetch" href="/assets/js/68.e8971efb.js"><link rel="prefetch" href="/assets/js/69.f13b68e6.js"><link rel="prefetch" href="/assets/js/7.c3aab524.js"><link rel="prefetch" href="/assets/js/70.69f21f98.js"><link rel="prefetch" href="/assets/js/71.2962f382.js"><link rel="prefetch" href="/assets/js/72.2992e47f.js"><link rel="prefetch" href="/assets/js/73.174ff7b4.js"><link rel="prefetch" href="/assets/js/74.51867acd.js"><link rel="prefetch" href="/assets/js/75.48b46c45.js"><link rel="prefetch" href="/assets/js/76.6d0de916.js"><link rel="prefetch" href="/assets/js/77.f953fc79.js"><link rel="prefetch" href="/assets/js/78.0d34bdce.js"><link rel="prefetch" href="/assets/js/79.8b7301be.js"><link rel="prefetch" href="/assets/js/80.2214c730.js"><link rel="prefetch" href="/assets/js/81.7c9e39e1.js"><link rel="prefetch" href="/assets/js/82.fc99cfa7.js"><link rel="prefetch" href="/assets/js/83.a1a65eec.js"><link rel="prefetch" href="/assets/js/84.be5a0a49.js"><link rel="prefetch" href="/assets/js/85.f17bfd83.js"><link rel="prefetch" href="/assets/js/86.db5d6c16.js"><link rel="prefetch" href="/assets/js/87.e10827d4.js"><link rel="prefetch" href="/assets/js/88.4bb2f2ae.js"><link rel="prefetch" href="/assets/js/89.d26b9b66.js"><link rel="prefetch" href="/assets/js/90.6daf5975.js"><link rel="prefetch" href="/assets/js/91.45ecdb37.js"><link rel="prefetch" href="/assets/js/92.f286e6b0.js"><link rel="prefetch" href="/assets/js/93.1f11519d.js"><link rel="prefetch" href="/assets/js/94.4ef1e3ce.js"><link rel="prefetch" href="/assets/js/95.3c07b4bf.js"><link rel="prefetch" href="/assets/js/96.1207c89f.js"><link rel="prefetch" href="/assets/js/97.fd8d86eb.js"><link rel="prefetch" href="/assets/js/98.60504ae0.js"><link rel="prefetch" href="/assets/js/99.30fd60ad.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.2f354cfa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.51c3fc7f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">HeroKing的个人笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="afterEnd" class="dropdown-title"><span class="title">afterEnd</span> <span class="arrow down"></span></button> <button type="button" aria-label="afterEnd" class="mobile-dropdown-title"><span class="title">afterEnd</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/afterEnd/mongodb/" class="nav-link">
  Mongodb
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/JMS/" class="nav-link">
  JMS
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/" class="nav-link">
  After End
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="algorithms" class="dropdown-title"><span class="title">algorithms</span> <span class="arrow down"></span></button> <button type="button" aria-label="algorithms" class="mobile-dropdown-title"><span class="title">algorithms</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithms/" class="nav-link">
  Algorithms
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="frontEnd" class="dropdown-title"><span class="title">frontEnd</span> <span class="arrow down"></span></button> <button type="button" aria-label="frontEnd" class="mobile-dropdown-title"><span class="title">frontEnd</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontEnd/autojs/" class="nav-link">
  Autojs
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/css/" class="nav-link">
  Css
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/demo/" class="nav-link">
  Demo
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/express/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/" class="nav-link router-link-active">
  Front End
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/ts/" class="nav-link">
  Ts
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="life" class="dropdown-title"><span class="title">life</span> <span class="arrow down"></span></button> <button type="button" aria-label="life" class="mobile-dropdown-title"><span class="title">life</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/life/" class="nav-link">
  Life
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="network" class="dropdown-title"><span class="title">network</span> <span class="arrow down"></span></button> <button type="button" aria-label="network" class="mobile-dropdown-title"><span class="title">network</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/network/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/network/proxy/" class="nav-link">
  Proxy
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="software" class="dropdown-title"><span class="title">software</span> <span class="arrow down"></span></button> <button type="button" aria-label="software" class="mobile-dropdown-title"><span class="title">software</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/software/ftp/" class="nav-link">
  Ftp
</a></li><li class="dropdown-item"><!----> <a href="/software/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/software/samba/" class="nav-link">
  Samba
</a></li><li class="dropdown-item"><!----> <a href="/software/" class="nav-link">
  Software
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="system" class="dropdown-title"><span class="title">system</span> <span class="arrow down"></span></button> <button type="button" aria-label="system" class="mobile-dropdown-title"><span class="title">system</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/system/Hackintosh/" class="nav-link">
  Hackintosh
</a></li><li class="dropdown-item"><!----> <a href="/system/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/system/" class="nav-link">
  System
</a></li><li class="dropdown-item"><!----> <a href="/system/windows/" class="nav-link">
  Windows
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="afterEnd" class="dropdown-title"><span class="title">afterEnd</span> <span class="arrow down"></span></button> <button type="button" aria-label="afterEnd" class="mobile-dropdown-title"><span class="title">afterEnd</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/afterEnd/mongodb/" class="nav-link">
  Mongodb
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/JMS/" class="nav-link">
  JMS
</a></li><li class="dropdown-item"><!----> <a href="/afterEnd/" class="nav-link">
  After End
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="algorithms" class="dropdown-title"><span class="title">algorithms</span> <span class="arrow down"></span></button> <button type="button" aria-label="algorithms" class="mobile-dropdown-title"><span class="title">algorithms</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithms/" class="nav-link">
  Algorithms
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="frontEnd" class="dropdown-title"><span class="title">frontEnd</span> <span class="arrow down"></span></button> <button type="button" aria-label="frontEnd" class="mobile-dropdown-title"><span class="title">frontEnd</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/frontEnd/autojs/" class="nav-link">
  Autojs
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/css/" class="nav-link">
  Css
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/demo/" class="nav-link">
  Demo
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/express/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Express
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/" class="nav-link router-link-active">
  Front End
</a></li><li class="dropdown-item"><!----> <a href="/frontEnd/ts/" class="nav-link">
  Ts
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="life" class="dropdown-title"><span class="title">life</span> <span class="arrow down"></span></button> <button type="button" aria-label="life" class="mobile-dropdown-title"><span class="title">life</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/life/" class="nav-link">
  Life
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="network" class="dropdown-title"><span class="title">network</span> <span class="arrow down"></span></button> <button type="button" aria-label="network" class="mobile-dropdown-title"><span class="title">network</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/network/" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/network/proxy/" class="nav-link">
  Proxy
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="software" class="dropdown-title"><span class="title">software</span> <span class="arrow down"></span></button> <button type="button" aria-label="software" class="mobile-dropdown-title"><span class="title">software</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/software/ftp/" class="nav-link">
  Ftp
</a></li><li class="dropdown-item"><!----> <a href="/software/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/software/samba/" class="nav-link">
  Samba
</a></li><li class="dropdown-item"><!----> <a href="/software/" class="nav-link">
  Software
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="system" class="dropdown-title"><span class="title">system</span> <span class="arrow down"></span></button> <button type="button" aria-label="system" class="mobile-dropdown-title"><span class="title">system</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/system/Hackintosh/" class="nav-link">
  Hackintosh
</a></li><li class="dropdown-item"><!----> <a href="/system/linux/" class="nav-link">
  Linux
</a></li><li class="dropdown-item"><!----> <a href="/system/" class="nav-link">
  System
</a></li><li class="dropdown-item"><!----> <a href="/system/windows/" class="nav-link">
  Windows
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Express</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontEnd/express/" aria-current="page" class="active sidebar-link">Express源码学习</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontEnd/express/#常规使用" class="sidebar-link">常规使用</a></li><li class="sidebar-sub-header"><a href="/frontEnd/express/#模块类关系图" class="sidebar-link">模块类关系图</a></li><li class="sidebar-sub-header"><a href="/frontEnd/express/#请求处理时序图" class="sidebar-link">请求处理时序图</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="express源码学习"><a href="#express源码学习" class="header-anchor">#</a> Express源码学习</h1> <h2 id="常规使用"><a href="#常规使用" class="header-anchor">#</a> 常规使用</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/info'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;req time: &quot;</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;secode layer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;third layer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">&quot;/info&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/info2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;req time: &quot;</span><span class="token punctuation">,</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;secode layer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;third layer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">&quot;/info&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Example app listening on port 3000</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="模块类关系图"><a href="#模块类关系图" class="header-anchor">#</a> 模块类关系图</h2> <blockquote><p>使用plantuml解析器解析</p></blockquote> <div class="language-plantuml extra-class"><pre class="language-plantuml"><code><span class="token delimiter punctuation">@startuml</span> ClassRelationship

<span class="token keyword">enum</span> methods <span class="token punctuation">{</span>
    get<span class="token punctuation">,</span>
    post<span class="token punctuation">,</span>
    put<span class="token punctuation">,</span>
    delete<span class="token punctuation">,</span>
    patch<span class="token punctuation">,</span>
    options<span class="token punctuation">,</span>
    head<span class="token punctuation">,</span>
    connect<span class="token punctuation">,</span>
    <span class="token arrow operator">...o</span>ther http methods<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">' 1. 引入 Node.js 原生模块（父类）</span>
<span class="token keyword">class</span> EventEmitter <span class="token punctuation">{</span>
    <span class="token comment">' Node.js EventEmitter 核心方法（精简关键）</span>
    + on<span class="token punctuation">(</span>eventName<span class="token punctuation">:</span> string<span class="token punctuation">,</span> listener<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> this
    + emit<span class="token punctuation">(</span>eventName<span class="token punctuation">:</span> string<span class="token punctuation">,</span> <span class="token punctuation">...</span>args<span class="token punctuation">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> boolean
    + once<span class="token punctuation">(</span>eventName<span class="token punctuation">:</span> string<span class="token punctuation">,</span> listener<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> this
    + off<span class="token punctuation">(</span>eventName<span class="token punctuation">:</span> string<span class="token punctuation">,</span> listener<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> this
    # _events<span class="token punctuation">:</span> Object  ' 私有属性：存储事件与监听器映射
<span class="token punctuation">}</span>
<span class="token comment">' 基础类型定义</span>
<span class="token keyword">interface</span> MiddlewareFunction <span class="token punctuation">{</span>
    + <span class="token punctuation">(</span>req<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> next<span class="token punctuation">:</span> NextFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> void
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> NextFunction <span class="token punctuation">{</span>
    + <span class="token punctuation">(</span>err?<span class="token punctuation">:</span> Error<span class="token punctuation">)</span><span class="token punctuation">:</span> void
<span class="token punctuation">}</span>

<span class="token comment">' Express 核心模块</span>
<span class="token keyword">package</span> express <span class="token punctuation">{</span>
    <span class="token keyword">class</span> Express <span class="token punctuation">{</span>
        - application<span class="token punctuation">:</span> Application
        - request <span class="token punctuation">:</span> Request
        - response <span class="token punctuation">:</span> Response
        + default<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Application
        + json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void
        + raw<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void
        + Router<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Router # 创建一个新的路由对象
        + static<span class="token punctuation">(</span>root<span class="token punctuation">:</span> string<span class="token punctuation">)</span><span class="token punctuation">:</span> void
        + text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void
        + urlencoded<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">' Application 核心类</span>
<span class="token keyword">class</span> Application extends EventEmitter <span class="token punctuation">{</span>
    + request<span class="token punctuation">:</span> Request
    + response<span class="token punctuation">:</span> Response
    + cache<span class="token punctuation">:</span> Object               # 缓存
    + engines<span class="token punctuation">:</span> Object             # 模板引擎
    + settings<span class="token punctuation">:</span> Object           # 应用配置
    + router<span class="token punctuation">:</span> Router             # 路由分发器
    + locals<span class="token punctuation">:</span> Object              # 模板变量<span class="token punctuation">,</span>在通过 res.render 渲染的模板中可用
    + mountpath<span class="token punctuation">:</span> String           # 当前应用被当做子应用挂载的一个或多个路径

    + init<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void                # 初始化 server
    + defaultConfiguration<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> void  # 默认配置<span class="token punctuation">,</span>监听mount事件
    + handle<span class="token punctuation">(</span>req<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> out<span class="token punctuation">:</span> NextFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> void  # 处理请求
    + use<span class="token punctuation">(</span>path<span class="token punctuation">:</span> String<span class="token punctuation">,</span> middleware<span class="token punctuation">:</span> MiddlewareFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> Application    # 使用中间件<span class="token punctuation">,</span>代理的Router.use
    + use<span class="token punctuation">(</span>middleware<span class="token punctuation">:</span> MiddlewareFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> Application
    + use<span class="token punctuation">(</span><span class="token punctuation">...</span>middleware<span class="token punctuation">:</span> MiddlewareFunction<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Application
    + route<span class="token punctuation">(</span>path<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> Router   # 为path创建一个路由<span class="token punctuation">,</span>代理Router.route<span class="token punctuation">(</span><span class="token punctuation">)</span>
    + param<span class="token punctuation">(</span>name<span class="token punctuation">:</span> String<span class="token punctuation">,</span> handler<span class="token punctuation">:</span> ParamHandlerFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> Application  # 为参数设置处理函数<span class="token punctuation">,</span>代理Router.param<span class="token punctuation">(</span><span class="token punctuation">)</span>
    + set<span class="token punctuation">(</span>setting<span class="token punctuation">:</span> String<span class="token punctuation">,</span> value?<span class="token punctuation">:</span> any<span class="token punctuation">)</span><span class="token punctuation">:</span> Application   # 设置/获取this.settings对象
    + path<span class="token punctuation">(</span>path<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> String    # 获取当前应用挂载完整路径
    + get/post/put/methods/all<span class="token punctuation">(</span>path<span class="token punctuation">:</span> String<span class="token punctuation">,</span> <span class="token punctuation">...</span>handlers<span class="token punctuation">:</span> MiddlewareFunction<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Application # 路由处理<span class="token punctuation">,</span> 代理Route.methods<span class="token punctuation">(</span><span class="token punctuation">)</span>
    + listen<span class="token punctuation">(</span>port<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> hostname<span class="token punctuation">:</span> String<span class="token punctuation">,</span> backlog<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> callback<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Server
<span class="token punctuation">}</span>

<span class="token comment">' Router 路由系统</span>
<span class="token keyword">class</span> Router <span class="token punctuation">{</span>
    - stack<span class="token punctuation">:</span> Layer<span class="token punctuation">[</span><span class="token punctuation">]</span>             # 路由层栈
    - methods<span class="token punctuation">:</span> Object            # 注册路由的 HTTP 方法
    - params<span class="token punctuation">:</span> Object             # 参数解析器
    - caseSensitive<span class="token punctuation">:</span> Boolean     # 路径大小写敏感
    - mergeParams<span class="token punctuation">:</span> Boolean       # 合并参数

    + route<span class="token punctuation">(</span>path<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> Route    # 创建一个Route<span class="token punctuation">(</span>path<span class="token punctuation">)</span> 和 layer<span class="token punctuation">(</span>path<span class="token punctuation">,</span> route.dispatch<span class="token punctuation">)</span>
    + get/post/put/methods/all<span class="token punctuation">(</span>path<span class="token punctuation">:</span> String<span class="token punctuation">,</span> <span class="token punctuation">...</span>handlers<span class="token punctuation">:</span> MiddlewareFunction<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Router # 路由处理<span class="token punctuation">,</span> 代理Route.methods<span class="token punctuation">(</span><span class="token punctuation">)</span>
    + use<span class="token punctuation">(</span>path<span class="token punctuation">:</span> String<span class="token punctuation">,</span> middleware<span class="token punctuation">:</span> MiddlewareFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> Router
    + handle<span class="token punctuation">(</span>req<span class="token punctuation">:</span> Request<span class="token punctuation">,</span>res<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> callback<span class="token punctuation">:</span>Function <span class="token punctuation">)</span><span class="token punctuation">:</span> void  # 处理请求
<span class="token punctuation">}</span>

<span class="token comment">' Route 路由匹配层</span>
<span class="token keyword">class</span> Route <span class="token punctuation">{</span>
    - path<span class="token punctuation">:</span> String               # 路由路径
    - stack<span class="token punctuation">:</span> Layer<span class="token punctuation">[</span><span class="token punctuation">]</span>             # 处理函数栈
    - methods<span class="token punctuation">:</span> Object            # 支持的 HTTP 方法
    - sensitive<span class="token punctuation">:</span> Boolean         # 大小写敏感
    - strict<span class="token punctuation">:</span> Boolean            # 严格路径匹配

    + get<span class="token punctuation">(</span>handler<span class="token punctuation">:</span> MiddlewareFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> Route
    + post<span class="token punctuation">(</span>handler<span class="token punctuation">:</span> MiddlewareFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> Route
    + all<span class="token punctuation">(</span>handler<span class="token punctuation">:</span> MiddlewareFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> Route
    + dispatch<span class="token punctuation">(</span>req<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> out<span class="token punctuation">:</span> NextFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> void # 处理请求
<span class="token punctuation">}</span>

<span class="token comment">' Layer 路由处理单元</span>
<span class="token keyword">class</span> Layer <span class="token punctuation">{</span>
    - path<span class="token punctuation">:</span> String               # 匹配路径
    - handle<span class="token punctuation">:</span> MiddlewareFunction # 处理函数
    - method<span class="token punctuation">:</span> String             # 匹配的 HTTP 方法
    - name<span class="token punctuation">:</span> String               # 层名称
    - params<span class="token punctuation">:</span> Object             # 参数缓存

    + handle_request<span class="token punctuation">(</span>req<span class="token punctuation">:</span> Request<span class="token punctuation">,</span> res<span class="token punctuation">:</span> Response<span class="token punctuation">,</span> next<span class="token punctuation">:</span> NextFunction<span class="token punctuation">)</span><span class="token punctuation">:</span> void
    + match<span class="token punctuation">(</span>path<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> Boolean
<span class="token punctuation">}</span>

<span class="token comment">' 请求对象扩展</span>
<span class="token keyword">class</span> Request extends IncomingMessage<span class="token punctuation">{</span>
    - originalUrl<span class="token punctuation">:</span> String        # 原始 URL
    - baseUrl<span class="token punctuation">:</span> String            # 挂载路径
    - method<span class="token punctuation">:</span> String             # 请求方法
    - url<span class="token punctuation">:</span> String                # 当前 URL
    - path<span class="token punctuation">:</span> String                # 当前
    - protocol<span class="token punctuation">:</span> String                # 当前
    - host<span class="token punctuation">:</span> String                # 当前
    - ip<span class="token punctuation">:</span> String                # 当前
    - headers<span class="token punctuation">:</span> Object            # 请求头
    - query<span class="token punctuation">:</span> Object              # 查询参数
    - params<span class="token punctuation">:</span> Object             # 路由参数
    - body<span class="token punctuation">:</span> Object               # 请求体

    + get<span class="token punctuation">(</span>headerName<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> String
    + header<span class="token punctuation">(</span>headerName<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> String
    + <span class="token keyword">is</span><span class="token punctuation">(</span>types<span class="token punctuation">:</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Boolean
    + accepts<span class="token punctuation">(</span>types<span class="token punctuation">:</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> String
<span class="token punctuation">}</span>

<span class="token comment">' 响应对象扩展</span>
<span class="token keyword">class</span> Response extends ServerResponse<span class="token punctuation">{</span>
    - statusCode<span class="token punctuation">:</span> Number         # 状态码
    - headersSent<span class="token punctuation">:</span> Boolean       # 响应是否已发送
    - _headers<span class="token punctuation">:</span> Object           # 响应头

    + send<span class="token punctuation">(</span>body<span class="token punctuation">:</span> Any<span class="token punctuation">)</span><span class="token punctuation">:</span> Response
    + status<span class="token punctuation">(</span>code<span class="token punctuation">:</span> Number<span class="token punctuation">)</span><span class="token punctuation">:</span> Response
    + json<span class="token punctuation">(</span>data<span class="token punctuation">:</span> Object<span class="token punctuation">)</span><span class="token punctuation">:</span> Response
    + redirect<span class="token punctuation">(</span>url<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> Response
    + set<span class="token punctuation">(</span>header<span class="token punctuation">:</span> String<span class="token punctuation">,</span> value<span class="token punctuation">:</span> String<span class="token punctuation">)</span><span class="token punctuation">:</span> Response
<span class="token punctuation">}</span>

<span class="token comment">' 服务器封装</span>
<span class="token keyword">class</span> Server <span class="token punctuation">{</span>
    - httpServer<span class="token punctuation">:</span> http.Server    # Node.js 原生服务器
    - _events<span class="token punctuation">:</span> EventEmitter      # 事件发射器

    + listen<span class="token punctuation">(</span>port<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> hostname<span class="token punctuation">:</span> String<span class="token punctuation">,</span> backlog<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> callback<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> Server
    + close<span class="token punctuation">(</span>callback<span class="token punctuation">:</span> Function<span class="token punctuation">)</span><span class="token punctuation">:</span> void
<span class="token punctuation">}</span>

<span class="token comment">' 关联关系</span>
Express <span class="token arrow operator">--&gt;</span> Application <span class="token punctuation">:</span> creates
Application <span class="token arrow operator">--&gt;</span> Router <span class="token punctuation">:</span> uses
Router <span class="token arrow operator">--&gt;</span> Route <span class="token punctuation">:</span> creates
Route <span class="token arrow operator">--&gt;</span> Layer <span class="token punctuation">:</span> contains
Router <span class="token arrow operator">--&gt;</span> Layer <span class="token punctuation">:</span> contains
Layer <span class="token arrow operator">--&gt;</span> MiddlewareFunction <span class="token punctuation">:</span> executes
Application <span class="token arrow operator">--&gt;</span> Server <span class="token punctuation">:</span> creates
Request <span class="token arrow operator">--&gt;</span> Response <span class="token punctuation">:</span> associated
Response <span class="token arrow operator">--&gt;</span> NextFunction <span class="token punctuation">:</span> uses
Application <span class="token arrow operator">--&gt;</span> Application <span class="token punctuation">:</span> uses
</code></pre></div><h2 id="请求处理时序图"><a href="#请求处理时序图" class="header-anchor">#</a> 请求处理时序图</h2> <p>应用启动后创建好Router的layer 和Route的layer stack, 请求处理时串行Router的layer stack中所有的Route的layer stack</p> <div class="language-plantuml extra-class"><pre class="language-plantuml"><code><span class="token delimiter punctuation">@startuml</span> ExpressSimplifiedSequence
<span class="token keyword">actor</span> Developer
<span class="token keyword">participant</span> <span class="token string">&quot;app&quot;</span> <span class="token keyword">as</span> Application
<span class="token keyword">participant</span> <span class="token string">&quot;app.router&quot;</span> <span class="token keyword">as</span> Router
<span class="token keyword">participant</span> <span class="token string">&quot;route&quot;</span> <span class="token keyword">as</span> Route
<span class="token keyword">participant</span> <span class="token string">&quot;layer&quot;</span> <span class="token keyword">as</span> Layer


<span class="token comment">' 应用初始化</span>
Developer <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> const app = express<span class="token punctuation">(</span><span class="token punctuation">)</span>
Application <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> app.init<span class="token punctuation">(</span><span class="token punctuation">)</span> \n app.defaultConfiguration<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">' 注册/info路由</span>
Developer <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> app.get<span class="token punctuation">(</span>'/info'<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
Application <span class="token arrow operator">-&gt;</span> Router<span class="token punctuation">:</span> router.route<span class="token punctuation">(</span>'/info'<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Router<span class="token punctuation">:</span> 初始化<span class="token punctuation">(</span>单例模式<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Route<span class="token punctuation">:</span> new Route<span class="token punctuation">(</span>'/info'<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> new Layer<span class="token punctuation">(</span>'/info'<span class="token punctuation">,</span>router.dispatch<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Router<span class="token punctuation">:</span> Layer关联Route\nrouter.stack.push<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> 返回Route
Application <span class="token arrow operator">-&gt;</span> Route<span class="token punctuation">:</span> route.get<span class="token punctuation">(</span>h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> new Layer<span class="token punctuation">(</span>'/'<span class="token punctuation">,</span> h1<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> new Layer<span class="token punctuation">(</span>'/'<span class="token punctuation">,</span> h2<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> new Layer<span class="token punctuation">(</span>'/'<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Route<span class="token punctuation">:</span> this.stack.push<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> return

<span class="token comment">' 注册/info2路由</span>
Developer <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> app.get<span class="token punctuation">(</span>'/info2'<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
Application <span class="token arrow operator">-&gt;</span> Router<span class="token punctuation">:</span> router.route<span class="token punctuation">(</span>'/info2'<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Route<span class="token punctuation">:</span> new Route<span class="token punctuation">(</span>'/info2'<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> new Layer<span class="token punctuation">(</span>'/info2'<span class="token punctuation">,</span>router.dispatch<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Router<span class="token punctuation">:</span> Layer关联Route\nrouter.stack.push<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> 返回Route
Application <span class="token arrow operator">-&gt;</span> Route<span class="token punctuation">:</span> route.get<span class="token punctuation">(</span>h1<span class="token punctuation">,</span> h2<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> new Layer<span class="token punctuation">(</span>'/'<span class="token punctuation">,</span> h1<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> new Layer<span class="token punctuation">(</span>'/'<span class="token punctuation">,</span> h2<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> new Layer<span class="token punctuation">(</span>'/'<span class="token punctuation">,</span> h3<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Route<span class="token punctuation">:</span> this.stack.push<span class="token punctuation">(</span>layer<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> return


<span class="token comment">' 启动服务器</span>
Developer <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> app.listen<span class="token punctuation">(</span>3000<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>

<span class="token comment">' 创建请求</span>
Developer <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> req.get<span class="token punctuation">(</span>'/info'<span class="token punctuation">)</span>
Application <span class="token arrow operator">-&gt;</span> Application<span class="token punctuation">:</span> this.handle<span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> out<span class="token punctuation">)</span>
<span class="token keyword">note</span> left of Application
这里的req<span class="token punctuation">,</span>res为原始的请求对象和响应对象
  - req.res = res<span class="token punctuation">;</span> res.req = req<span class="token punctuation">;</span> 保存关联
  - Object.setPrototypeOf<span class="token punctuation">(</span>req<span class="token punctuation">,</span> app.request<span class="token punctuation">)</span> 
  - Object.setPrototypeOf<span class="token punctuation">(</span>res<span class="token punctuation">,</span> app.response<span class="token punctuation">)</span>
  - 原型方式拓展req<span class="token punctuation">,</span>res
<span class="token keyword">end note</span>
Application <span class="token arrow operator">-&gt;</span> Router<span class="token punctuation">:</span> router.handle<span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> finalhandler<span class="token punctuation">)</span>
Router <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> 启动next方法 \n 遍历stack查找匹配的layer和Route \nlayer.match<span class="token punctuation">(</span>'/info'<span class="token punctuation">)</span>
Layer <span class="token arrow operator">-&gt;</span> Router<span class="token punctuation">:</span> 返回是否match
Router <span class="token arrow operator">-&gt;</span> Route<span class="token punctuation">:</span> route._handlesMethod<span class="token punctuation">(</span>'GET'<span class="token punctuation">)</span>\n判断Route的方法是否匹配
Route <span class="token arrow operator">-&gt;</span> Router<span class="token punctuation">:</span> 返回是否match
Router <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> layer.handleRequest<span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
Layer <span class="token arrow operator">-&gt;</span> Route<span class="token punctuation">:</span> route.dispatch<span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
Route <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> 启动next方法 \n 遍历stack根据method查找匹配的layer \nlayer.handleRequest<span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span>\n执行传入的h1<span class="token punctuation">,</span>h1中继续调用next

Route <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> layer.handleRequest<span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span>\n执行传入的h2<span class="token punctuation">,</span>h2中继续调用next
Route <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> layer.handleRequest<span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span>\n执行传入的h3<span class="token punctuation">,</span>h3中继续调用next
<span class="token keyword">note</span> left of Route
一直在压栈next方法<span class="token punctuation">,</span>最后在慢慢弹栈
<span class="token keyword">end note</span>

Router <span class="token arrow operator">-&gt;</span> Layer<span class="token punctuation">:</span> Router.next\n查找匹配stack中其他的layer\n重复上述步骤
Router <span class="token arrow operator">-&gt;</span> Developer<span class="token punctuation">:</span> 响应内容

<span class="token delimiter punctuation">@enduml</span></code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f6a8c955.js" defer></script><script src="/assets/js/2.163e2f28.js" defer></script><script src="/assets/js/1.f9594dd0.js" defer></script><script src="/assets/js/47.9d307bbb.js" defer></script>
  </body>
</html>
